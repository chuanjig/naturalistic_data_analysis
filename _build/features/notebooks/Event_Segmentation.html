---
redirect_from:
  - "/features/notebooks/event-segmentation"
interact_link: content/features/notebooks/Event_Segmentation.ipynb
kernel_name: python3
kernel_path: content/features/notebooks
has_widgets: false
title: |-
  Event Segmentation
pagenum: 10
prev_page:
  url: /features/notebooks/Intersubject_RSA.html
next_page:
  url: /features/notebooks/HiddenSemiMarkovModel.html
suffix: .ipynb
search: event events boundaries hmm recall gsbs data model patterns movie both between segmentation activity timepoints fit states well used during using set human optimal distance voxel perception org here also baldassano geerligs show search subjects only finding correlation corresponding log likelihood measure timepoint similarity comparison determine t same chris linda greedy state boundary different load angular gyrus loading doi dataset applying plot models fitting need specify note test below since matrix being split merge fits labeled possible datasets variance fmri gordon fleetwood shows spatial across free watching methods performing dr phd assistant professor com et al subject recalled narrative nii

comment: "***PROGRAMMATICALLY GENERATED, DO NOT EDIT. SEE ORIGINAL FILES IN /content***"
---

    <main class="jupyter-page">
    <div id="page-info"><div id="page-title">Event Segmentation</div>
</div>
    <div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Event-segmentation-and-alignment-in-fMRI-data">Event segmentation and alignment in fMRI data<a class="anchor-link" href="#Event-segmentation-and-alignment-in-fMRI-data"> </a></h1><p><em>Written by Chris Baldassano, Gordon Fleetwood, and Linda Geerligs</em></p>
<p>This tutorial shows how to detect event boundaries in fMRI data (defined as shifts in spatial patterns of voxel activity) and align events across perception and recall. We'll show how both an HMM (Hidden Markov Model) and GSBS (Greedy State Boundary Search) can be used to find boundaries, and how the HMM (or GSBS+HMM) can be used to track reactivation of event patterns during free recall.</p>
<p>Let's get started by watching some short videos introducing the concept of event segmentation and two different methods for performing this type of analysis.</p>
<p>First, <a href="http://www.dpmlab.org/">Dr. Chris Baldassano, PhD</a>, an Assistant Professor at Columbia University, will introduce performing event segmentation using HMMs</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">YouTubeVideo</span>

<span class="n">YouTubeVideo</span><span class="p">(</span><span class="s1">&#39;-iDMphdGVxo&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">

<iframe
    width="400"
    height="300"
    src="https://www.youtube.com/embed/-iDMphdGVxo"
    frameborder="0"
    allowfullscreen
></iframe>

</div>

</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Next, <a href="https://lindageerligs.com/">Dr. Linda Geerligs, PhD</a> an Assistant Professor at the Donders Institute, will discuss how the Greedy State Boundary Search can be used to segment events from brain activity.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">YouTubeVideo</span><span class="p">(</span><span class="s1">&#39;KvwzjRtbJ6U&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">

<iframe
    width="400"
    height="300"
    src="https://www.youtube.com/embed/KvwzjRtbJ6U"
    frameborder="0"
    allowfullscreen
></iframe>

</div>

</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="0.-Load-Angular-Gyrus-data">0. Load Angular Gyrus data<a class="anchor-link" href="#0.-Load-Angular-Gyrus-data"> </a></h2><p>From the angular gyrus (area PG from (Eickhoff et al., 2005)), we'll load movie data from all subjects, and recall data from one subject. Subjects were watching the first hour of <a href="https://en.wikipedia.org/wiki/A_Study_in_Pink">A Study in Pink</a> (here we are loading only the first half of this data), and then freely recalled the narrative. Please refer to <a href="https://doi.org/10.1038/nn.4450">Chen et al. (2017)</a> to learn more about this dataset.</p>
<p>We can load this data from the nii files by applying an angular gyrus mask, which we then cache into a numpy file to speed up loading in the future. If you'd like to skip this nii-loading step (which can be slow), you can download the npy files from <a href="https://figshare.com/articles/Sherlock_data_for_OHBM/12436955">figshare: Sherlock data for OHBM</a>.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">sys</span> 
<span class="kn">import</span> <span class="nn">os</span>    
<span class="kn">from</span> <span class="nn">statesegmentation</span> <span class="kn">import</span> <span class="n">GSBS</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">brainiak.eventseg.event</span> <span class="kn">import</span> <span class="n">EventSegment</span>
<span class="kn">import</span> <span class="nn">nibabel</span> <span class="k">as</span> <span class="nn">nib</span>
<span class="kn">from</span> <span class="nn">nilearn.masking</span> <span class="kn">import</span> <span class="n">apply_mask</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">zscore</span><span class="p">,</span> <span class="n">norm</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.patches</span> <span class="k">as</span> <span class="nn">patches</span>
<span class="o">%</span><span class="k">matplotlib</span> inline

<span class="n">smallsize</span><span class="o">=</span><span class="mi">14</span><span class="p">;</span> <span class="n">mediumsize</span><span class="o">=</span><span class="mi">16</span><span class="p">;</span> <span class="n">largesize</span><span class="o">=</span><span class="mi">18</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;xtick&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">smallsize</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;ytick&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">smallsize</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;legend&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">mediumsize</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;figure&#39;</span><span class="p">,</span> <span class="n">titlesize</span><span class="o">=</span><span class="n">largesize</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;axes&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">mediumsize</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;axes&#39;</span><span class="p">,</span> <span class="n">titlesize</span><span class="o">=</span><span class="n">mediumsize</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;Sherlock_AG_movie.npy&#39;</span><span class="p">)</span> <span class="ow">or</span>
    <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;Sherlock_AG_recall.npy&#39;</span><span class="p">)):</span>
    <span class="n">Sherlock_path</span> <span class="o">=</span> <span class="s1">&#39;../../Sherlock/&#39;</span>
    <span class="n">movie</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cached data not found, loading from nii files&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">17</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   Loading sub-</span><span class="si">%02d</span><span class="s1">...&#39;</span> <span class="o">%</span> <span class="n">sub</span><span class="p">)</span>
        <span class="n">movie</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">apply_mask</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Sherlock_path</span><span class="p">,</span> <span class="s1">&#39;fmriprep&#39;</span><span class="p">,</span><span class="s1">&#39;sub-</span><span class="si">%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">sub</span><span class="p">,</span> <span class="s1">&#39;func&#39;</span><span class="p">,</span> \
                               <span class="s1">&#39;sub-</span><span class="si">%02d</span><span class="s1">_denoise_smooth6mm_task-sherlockPart1_space-MNI152NLin2009cAsym_desc-preproc_bold.nii.gz&#39;</span> <span class="o">%</span> <span class="n">sub</span><span class="p">),</span>
                               <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Sherlock_path</span><span class="p">,</span> <span class="s1">&#39;AG_mask.nii.gz&#39;</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">sub</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
            <span class="n">recall</span> <span class="o">=</span> <span class="n">apply_mask</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Sherlock_path</span><span class="p">,</span> <span class="s1">&#39;fmriprep&#39;</span><span class="p">,</span><span class="s1">&#39;sub-</span><span class="si">%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">sub</span><span class="p">,</span> <span class="s1">&#39;func&#39;</span><span class="p">,</span> \
                               <span class="s1">&#39;sub-</span><span class="si">%02d</span><span class="s1">_denoise_smooth6mm_task-freerecall_space-MNI152NLin2009cAsym_desc-preproc_bold.nii.gz&#39;</span> <span class="o">%</span> <span class="n">sub</span><span class="p">),</span>
                               <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Sherlock_path</span><span class="p">,</span> <span class="s1">&#39;AG_mask.nii.gz&#39;</span><span class="p">))</span>

    <span class="n">valid_vox</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">union1d</span><span class="p">,</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">movie</span><span class="p">])</span>
    <span class="n">movie</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">[:,</span><span class="n">valid_vox</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">movie</span><span class="p">]</span>
    <span class="n">recall</span> <span class="o">=</span> <span class="n">recall</span><span class="p">[:</span><span class="mi">487</span><span class="p">,</span><span class="n">valid_vox</span><span class="p">]</span>  <span class="c1"># Recall of 1st half of movie takes 487 TRs </span>
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;Sherlock_AG_movie.npy&#39;</span><span class="p">,</span> <span class="n">movie</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;Sherlock_AG_recall.npy&#39;</span><span class="p">,</span> <span class="n">recall</span><span class="p">)</span>

    
<span class="n">movie</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;Sherlock_AG_movie.npy&#39;</span><span class="p">)</span>
<span class="n">recall</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;Sherlock_AG_recall.npy&#39;</span><span class="p">)</span>
<span class="n">movie_group</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">movie</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="1.-Finding-event-boundaries-during-perception">1. Finding event boundaries during perception<a class="anchor-link" href="#1.-Finding-event-boundaries-during-perception"> </a></h2>
</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="1.0-Warm-up:-Event-structure-in-activity-patterns">1.0 Warm-up: Event structure in activity patterns<a class="anchor-link" href="#1.0-Warm-up:-Event-structure-in-activity-patterns"> </a></h3><p>Before applying any model, a good first step is to plot the correlation between activity patterns for each pair of timepoints during the movie. In this dataset, this shows blocks along the diagonal, which indicates that activity patterns are remaining stable for periods of tens of timepoints. This is the kind of structure that the HMM and GSBS models will be looking for.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">movie_group</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Timepoint&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Timepoint&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Spatial pattern correlation&#39;</span><span class="p">);</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_png output_subarea ">
<img src="../../images/features/notebooks/Event_Segmentation_9_0.png"
>
</div>

</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="1.1-Fitting-the-HMM">1.1 Fitting the HMM<a class="anchor-link" href="#1.1-Fitting-the-HMM"> </a></h3><p>To use an HMM to find both the event timings and the patterns corresponding to each event, we can use the EventSegment class from the brainiak toolbox. We need to specify the number of events, which here we set to 29 (corresponding to the number of boundaries typically annotated by human subjects).</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">movie_HMM</span> <span class="o">=</span> <span class="n">EventSegment</span><span class="p">(</span><span class="n">n_events</span> <span class="o">=</span> <span class="mi">29</span><span class="p">)</span>
<span class="n">movie_HMM</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">movie_group</span><span class="p">);</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This fit produces:</p>
<ul>
<li>The log-likelihood (measuring overall model fit) over training. (Note that the log-likelihood on held-out test data is often a better measure of model quality - see below).</li>
<li>The mean voxel pattern for each event. Here we show only 1% of the voxels since the ROI is large.</li>
<li>A matrix showing the probability of being in each event at each timepoint. We can use this to derive the most likely timepoints where boundaries occur, and plot these on top of the timepoint similarity matrix for comparison.</li>
</ul>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Plotting the log-likelihood (measuring overall model fit)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">movie_HMM</span><span class="o">.</span><span class="n">ll_</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Log likelihood during training&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Model fitting steps&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>Text(0.5, 0, &#39;Model fitting steps&#39;)</pre>
</div>

</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_png output_subarea ">
<img src="../../images/features/notebooks/Event_Segmentation_13_1.png"
>
</div>

</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Plotting mean activity in each event for some example voxels</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">example_vox</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">movie_HMM</span><span class="o">.</span><span class="n">event_pat_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">100</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">movie_HMM</span><span class="o">.</span><span class="n">event_pat_</span><span class="p">[</span><span class="n">example_vox</span><span class="p">,:],</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Event number&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Voxels&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>Text(0, 0.5, &#39;Voxels&#39;)</pre>
</div>

</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_png output_subarea ">
<img src="../../images/features/notebooks/Event_Segmentation_14_1.png"
>
</div>

</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Plot probability of being in each event at each timepoint</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">matshow</span><span class="p">(</span><span class="n">movie_HMM</span><span class="o">.</span><span class="n">segments_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">tick_bottom</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Event probability&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>Text(0.5, 1.05, &#39;Event probability&#39;)</pre>
</div>

</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_text output_subarea ">
<pre>&lt;Figure size 864x432 with 0 Axes&gt;</pre>
</div>

</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_png output_subarea ">
<img src="../../images/features/notebooks/Event_Segmentation_15_2.png"
>
</div>

</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Identify event boundaries as timepoints when max probability switches events</span>
<span class="n">event_bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">movie_HMM</span><span class="o">.</span><span class="n">segments_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">nTRs</span> <span class="o">=</span> <span class="n">movie_group</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


<span class="c1"># Plot boundaries as boxes on top of timepoint correlation matrix</span>
<span class="k">def</span> <span class="nf">plot_tt_similarity_matrix</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">data_matrix</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">n_TRs</span><span class="p">,</span> <span class="n">title_text</span><span class="p">):</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">data_matrix</span><span class="p">),</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title_text</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;TR&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;TR&#39;</span><span class="p">)</span>
    
    <span class="c1"># plot the boundaries </span>
    <span class="n">bounds_aug</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="mi">0</span><span class="p">],</span> <span class="n">bounds</span><span class="p">,</span> <span class="p">[</span><span class="n">n_TRs</span><span class="p">]))</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bounds_aug</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">rect</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
            <span class="p">(</span><span class="n">bounds_aug</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">bounds_aug</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
            <span class="n">bounds_aug</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bounds_aug</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="n">bounds_aug</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bounds_aug</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="n">linewidth</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="n">facecolor</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>


<span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">title_text</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">Overlay the HMM-predicted event boundaries</span>
<span class="s1">on top of the TR-TR correlation matrix</span>
<span class="s1">&#39;&#39;&#39;</span>
<span class="n">plot_tt_similarity_matrix</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">movie_group</span><span class="p">,</span> <span class="n">event_bounds</span><span class="p">,</span> <span class="n">nTRs</span><span class="p">,</span> <span class="n">title_text</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_png output_subarea ">
<img src="../../images/features/notebooks/Event_Segmentation_16_0.png"
>
</div>

</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="1.2-Determining-the-number-of-events-with-the-HMM">1.2 Determining the number of events with the HMM<a class="anchor-link" href="#1.2-Determining-the-number-of-events-with-the-HMM"> </a></h3><p>What if we don't want to prespecify the number of events, but instead want to determine the number of events from the data? One way to determine the best number of events is to fit the model on a training set and then test the model fit on independent subjects.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">k_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">test_ll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">k_array</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">k_array</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Trying </span><span class="si">%d</span><span class="s1"> events&#39;</span> <span class="o">%</span> <span class="n">k</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   Fitting model on training subjects...&#39;</span><span class="p">)</span>
    <span class="n">movie_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">movie</span><span class="p">[:</span><span class="mi">8</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">movie_HMM</span> <span class="o">=</span> <span class="n">EventSegment</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="n">movie_HMM</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">movie_train</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   Testing model fit on held-out subjects...&#39;</span><span class="p">)</span>
    <span class="n">movie_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">movie</span><span class="p">[</span><span class="mi">8</span><span class="p">:],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">test_ll</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">movie_HMM</span><span class="o">.</span><span class="n">find_events</span><span class="p">(</span><span class="n">movie_test</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Trying 20 events
   Fitting model on training subjects...
   Testing model fit on held-out subjects...
Trying 30 events
   Fitting model on training subjects...
   Testing model fit on held-out subjects...
Trying 40 events
   Fitting model on training subjects...
   Testing model fit on held-out subjects...
Trying 50 events
   Fitting model on training subjects...
   Testing model fit on held-out subjects...
Trying 60 events
   Fitting model on training subjects...
   Testing model fit on held-out subjects...
</pre>
</div>
</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">k_array</span><span class="p">,</span> <span class="n">test_ll</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Number of events&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Log-likelihood&#39;</span><span class="p">)</span>

<span class="n">movie_dur</span> <span class="o">=</span> <span class="n">nTRs</span> <span class="o">*</span> <span class="mf">1.5</span>  <span class="c1"># Data acquired every 1.5 seconds</span>
<span class="n">secax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">secondary_xaxis</span><span class="p">(</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">functions</span><span class="o">=</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">movie_dur</span> <span class="o">/</span> <span class="n">x</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">movie_dur</span> <span class="o">/</span> <span class="n">x</span><span class="p">))</span>
<span class="n">secax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Average event length (sec)&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>Text(0.5, 0, &#39;Average event length (sec)&#39;)</pre>
</div>

</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/Users/chrisb/anaconda3/envs/OHBM/lib/python3.7/site-packages/ipykernel_launcher.py:6: RuntimeWarning: divide by zero encountered in true_divide
  
</pre>
</div>
</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_png output_subarea ">
<img src="../../images/features/notebooks/Event_Segmentation_19_2.png"
>
</div>

</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="1.3-Optimal-segmentation-with-the-HMM">1.3 Optimal segmentation with the HMM<a class="anchor-link" href="#1.3-Optimal-segmentation-with-the-HMM"> </a></h3><p>Since 40 events maximized the test log-likelihood, we'll generate two versions of HMM boundaries using 40 events. In addition to the "vanilla" HMM, we'll run an HMM with more flexibility during fitting (allowing for split-merge operations). This is slower (and so should usually only be used for generating a final segmentation), but can produce better fits if events are very uneven in duration. We will use these segmentations below for comparison with an alternative event segmentation method (GSBS) and with human labeled event boundaries.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fitting HMM with 40 events...&#39;</span><span class="p">)</span>
<span class="n">HMM40</span> <span class="o">=</span> <span class="n">EventSegment</span><span class="p">(</span><span class="n">n_events</span> <span class="o">=</span> <span class="mi">40</span><span class="p">)</span>
<span class="n">HMM40</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">movie_group</span><span class="p">)</span>
<span class="n">HMM40_bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">HMM40</span><span class="o">.</span><span class="n">segments_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fitting split-merge HMM with 40 events...&#39;</span><span class="p">)</span>
<span class="n">HMM40_SM</span> <span class="o">=</span> <span class="n">EventSegment</span><span class="p">(</span><span class="n">n_events</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span> <span class="n">split_merge</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">HMM40_SM</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">movie_group</span><span class="p">)</span>
<span class="n">HMM40_SM_bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">HMM40_SM</span><span class="o">.</span><span class="n">segments_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Fitting HMM with 40 events...
Fitting split-merge HMM with 40 events...
</pre>
</div>
</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="1.4-Finding-event-boundaries-with-GSBS">1.4 Finding event boundaries with GSBS<a class="anchor-link" href="#1.4-Finding-event-boundaries-with-GSBS"> </a></h3><p>GSBS is an alternative approach to finding both the event timings and the patterns corresponding to each event. The approach relies on a greedy search algorithm. To apply this algorithm, we can use the GSBS class from the statesegmentation toolbox. To determine the optimal number of event boundaries, GSBS uses the t-distance metric. T-distance relies on maximizing the similarity between timepoints that are part of the same event, while also minimizing the similarity between timepoints that are part of distinct but neighboring events. While t-distance can be optimized using cross-validation, like we did before for the log-likelihood, simulations showed that it performs best when the data are averaged across participants.</p>
<p>To run GSBS and find the optimal number of states, we need to specify the maximal number of events, which here we set to 140 to reduce computational time, but could be set equal to the number of timepoints for a complete search through all possible number of states.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">GSBS_states</span> <span class="o">=</span> <span class="n">GSBS</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">movie_group</span><span class="p">,</span> <span class="n">kmax</span> <span class="o">=</span> <span class="mi">140</span><span class="p">)</span>
<span class="n">GSBS_states</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This fit produces:</p>
<ul>
<li>The t-distance which is used to derive the optimal number of states</li>
<li>The boundaries and mean voxel patterns for each event. We can obtain this both for the optimal number of states, as well as for each possible number of states lower than (or equal to) the maximal number of states we specified. </li>
<li>The strength of each event boundary, as quantified by the correlation distance. This is a measure of the dissimilarity between consecutive states</li>
</ul>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Plotting the t-distance that is used to determine the optimal number of events</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The optimal number of events is &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">GSBS_states</span><span class="o">.</span><span class="n">nstates</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">GSBS_states</span><span class="o">.</span><span class="n">tdists</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Number of events&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;T-distance&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">GSBS_states</span><span class="o">.</span><span class="n">nstates</span><span class="p">,</span> <span class="n">GSBS_states</span><span class="o">.</span><span class="n">tdists</span><span class="p">[</span><span class="n">GSBS_states</span><span class="o">.</span><span class="n">nstates</span><span class="p">],</span> <span class="s1">&#39;ro&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span> <span class="s1">&#39;optimal number of events&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>The optimal number of events is 109
</pre>
</div>
</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;matplotlib.legend.Legend at 0x7fdbb005ac10&gt;</pre>
</div>

</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_png output_subarea ">
<img src="../../images/features/notebooks/Event_Segmentation_25_2.png"
>
</div>

</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>GSBS detects event boundaries in an iterative fashion. Boundaries that are detected first, also tend to show the largest change in voxel activity patterns between the corresponding events. We can measure this change in voxel activity patterns using the correlation distance.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#GSBS boundary order vs. strength</span>

<span class="c1">#obtaining GSBS event bounds for the optimal number of events</span>
<span class="n">GSBS_bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">GSBS_states</span><span class="o">.</span><span class="n">deltas</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">x</span><span class="o">=</span><span class="n">GSBS_states</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="n">GSBS_bounds</span><span class="p">]</span>
<span class="n">y</span><span class="o">=</span><span class="n">GSBS_states</span><span class="o">.</span><span class="n">strengths</span><span class="p">[</span><span class="n">GSBS_bounds</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">b</span><span class="p">,</span><span class="n">m</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">b</span><span class="o">+</span><span class="n">m</span><span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Order of boundary detection&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Correlation distance&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>Text(0, 0.5, &#39;Correlation distance&#39;)</pre>
</div>

</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_png output_subarea ">
<img src="../../images/features/notebooks/Event_Segmentation_27_1.png"
>
</div>

</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Plotting mean activity in the first 25 events for some example voxels</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">example_vox</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">GSBS_states</span><span class="o">.</span><span class="n">state_patterns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">100</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">GSBS_states</span><span class="o">.</span><span class="n">state_patterns</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">25</span><span class="p">,</span><span class="n">example_vox</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Event number&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Voxels&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;mean activity in the first 25 events for some example voxels&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>Text(0.5, 1.0, &#39;mean activity in the first 25 events for some example voxels&#39;)</pre>
</div>

</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_png output_subarea ">
<img src="../../images/features/notebooks/Event_Segmentation_28_1.png"
>
</div>

</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can visually compare the HMM and GSBS fits by plotting them on top of the timepoint correlation matrix. Since the optimal number of events selected by the two models is quite different, we also create a 40-event version of the GSBS bounds and a 109-event version of the HMM (and split-merge HMM) bounds for comparison. We zoom in on just the first 200 timepoints to allow for easier visualization.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#obtaining GSBS event bounds for 40 events (for comparison with the HMM)</span>
<span class="n">GSBS40_bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">GSBS_states</span><span class="o">.</span><span class="n">get_deltas</span><span class="p">(</span><span class="mi">40</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1">#obtaining HMM event bounds for 109 events (for comparison with the GSBS)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fitting HMM with 109 events...&#39;</span><span class="p">)</span>
<span class="n">HMM109</span> <span class="o">=</span> <span class="n">EventSegment</span><span class="p">(</span><span class="n">n_events</span> <span class="o">=</span> <span class="mi">109</span><span class="p">)</span>
<span class="n">HMM109</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">movie_group</span><span class="p">)</span>
<span class="n">HMM109_bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">HMM109</span><span class="o">.</span><span class="n">segments_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fitting split-merge HMM with 109 events...&#39;</span><span class="p">)</span>
<span class="n">HMM109_SM</span> <span class="o">=</span> <span class="n">EventSegment</span><span class="p">(</span><span class="n">n_events</span> <span class="o">=</span> <span class="mi">109</span><span class="p">,</span> <span class="n">split_merge</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">HMM109_SM</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">movie_group</span><span class="p">)</span>
<span class="n">HMM109_SM_bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">HMM109_SM</span><span class="o">.</span><span class="n">segments_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Fitting HMM with 109 events...
Fitting split-merge HMM with 109 events...
</pre>
</div>
</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">f</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">plot_tt_similarity_matrix</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">movie_group</span><span class="p">,</span> <span class="n">HMM40_bounds</span><span class="p">,</span> <span class="n">nTRs</span><span class="p">,</span> <span class="s1">&#39;HMM 40&#39;</span><span class="p">)</span>
<span class="n">plot_tt_similarity_matrix</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">movie_group</span><span class="p">,</span> <span class="n">HMM40_SM_bounds</span><span class="p">,</span> <span class="n">nTRs</span><span class="p">,</span> <span class="s1">&#39;HMM SM 40&#39;</span><span class="p">)</span>
<span class="n">plot_tt_similarity_matrix</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">movie_group</span><span class="p">,</span> <span class="n">GSBS40_bounds</span><span class="p">,</span> <span class="n">nTRs</span><span class="p">,</span> <span class="s1">&#39;GSBS 40&#39;</span><span class="p">)</span>
<span class="n">plot_tt_similarity_matrix</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">movie_group</span><span class="p">,</span> <span class="n">HMM109_bounds</span><span class="p">,</span> <span class="n">nTRs</span><span class="p">,</span> <span class="s1">&#39;HMM 109&#39;</span><span class="p">)</span>
<span class="n">plot_tt_similarity_matrix</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">movie_group</span><span class="p">,</span> <span class="n">HMM109_SM_bounds</span><span class="p">,</span> <span class="n">nTRs</span><span class="p">,</span> <span class="s1">&#39;HMM SM 109&#39;</span><span class="p">)</span>
<span class="n">plot_tt_similarity_matrix</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">movie_group</span><span class="p">,</span> <span class="n">GSBS_bounds</span><span class="p">,</span> <span class="n">nTRs</span><span class="p">,</span> <span class="s1">&#39;GSBS 109&#39;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">]);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">]);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">]);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">]);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(0.0, 200.0, 0.0, 200.0)</pre>
</div>

</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_png output_subarea ">
<img src="../../images/features/notebooks/Event_Segmentation_31_1.png"
>
</div>

</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="2.-Quantitatively-comparing-model-and-human-labeled-boundaries">2. Quantitatively comparing model and human-labeled boundaries<a class="anchor-link" href="#2.-Quantitatively-comparing-model-and-human-labeled-boundaries"> </a></h2><p>We can also quantitatively compare the event boundaries between different models, or between a model to human-labeled event boundaries. Because there is some ambiguity in both the stimulus and the model about exactly which timepoint the transition occurs at, we will count two boundaries as being a "match" if they are within 3 TRs (4.5 seconds) of each other.</p>
<p>To determine whether the match is statistically significant, we generate permuted versions of the boundaries as a null model for comparison.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Timepoints of event boundaries annotated by human raters</span>
<span class="n">human_bounds</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mi">26</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">131</span><span class="p">,</span> <span class="mi">143</span><span class="p">,</span> <span class="mi">157</span><span class="p">,</span> <span class="mi">173</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">204</span><span class="p">,</span> 
    <span class="mi">226</span><span class="p">,</span> <span class="mi">313</span><span class="p">,</span> <span class="mi">362</span><span class="p">,</span> <span class="mi">398</span><span class="p">,</span> <span class="mi">505</span><span class="p">,</span> <span class="mi">526</span><span class="p">,</span> <span class="mi">533</span><span class="p">,</span> <span class="mi">568</span><span class="p">,</span> <span class="mi">616</span><span class="p">,</span> <span class="mi">634</span><span class="p">,</span> <span class="mi">678</span><span class="p">,</span>
    <span class="mi">696</span><span class="p">,</span> <span class="mi">747</span><span class="p">,</span> <span class="mi">780</span><span class="p">,</span> <span class="mi">870</span><span class="p">,</span> <span class="mi">890</span>
<span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Computes fraction of &quot;ground truth&quot; bounds are covered by a set of proposed bounds</span>
<span class="c1"># Returns z score relative to a null distribution via permutation</span>
<span class="k">def</span> <span class="nf">match_z</span><span class="p">(</span><span class="n">proposed_bounds</span><span class="p">,</span> <span class="n">gt_bounds</span><span class="p">,</span> <span class="n">num_TRs</span><span class="p">):</span>
    <span class="n">nPerm</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">gt_lengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="mi">0</span><span class="p">],</span><span class="n">gt_bounds</span><span class="p">,[</span><span class="n">num_TRs</span><span class="p">])))</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nPerm</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nPerm</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">gt_bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">gt_lengths</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">gt_bounds</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">proposed_bounds</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">threshold</span><span class="p">):</span>
                <span class="n">match</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">match</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gt_bounds</span><span class="p">)</span>
        <span class="n">gt_lengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">gt_lengths</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">(</span><span class="n">match</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">match</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">match</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

<span class="n">bound_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">HMM40_bounds</span><span class="p">,</span> <span class="n">HMM40_SM_bounds</span><span class="p">,</span> <span class="n">GSBS40_bounds</span><span class="p">,</span> <span class="n">HMM109_bounds</span><span class="p">,</span> <span class="n">HMM109_SM_bounds</span><span class="p">,</span> <span class="n">GSBS_bounds</span><span class="p">,</span> <span class="n">human_bounds</span><span class="p">]</span>
<span class="n">matchz_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">bound_types</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">bound_types</span><span class="p">)))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">b1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bound_types</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">b2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bound_types</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">j</span><span class="p">:</span>
            <span class="n">matchz_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">match_z</span><span class="p">(</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">nTRs</span><span class="p">)</span>


<span class="n">matchz_mat</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">))]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mf">5.7</span><span class="p">))</span>
<span class="n">a</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">matchz_mat</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;HMM40&#39;</span><span class="p">,</span> <span class="s1">&#39;HMM_SM40&#39;</span><span class="p">,</span><span class="s1">&#39;GSBS40&#39;</span><span class="p">,</span> <span class="s1">&#39;HMM109&#39;</span><span class="p">,</span> <span class="s1">&#39;HMM_SM109&#39;</span><span class="p">,</span><span class="s1">&#39;GSBS109&#39;</span><span class="p">,</span> <span class="s1">&#39;Human&#39;</span><span class="p">],</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;HMM40&#39;</span><span class="p">,</span> <span class="s1">&#39;HMM_SM40&#39;</span><span class="p">,</span><span class="s1">&#39;GSBS40&#39;</span><span class="p">,</span> <span class="s1">&#39;HMM109&#39;</span><span class="p">,</span> <span class="s1">&#39;HMM_SM109&#39;</span><span class="p">,</span><span class="s1">&#39;GSBS109&#39;</span><span class="p">,</span> <span class="s1">&#39;Human&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Ground truth bounds&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Proposed bounds&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Match vs. null (z)&#39;</span><span class="p">)</span>
<span class="n">a</span><span class="o">.</span><span class="n">set_extent</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;P values for matches to Human bounds: &#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;HMM40=</span><span class="si">%f</span><span class="s1">, HMM_SM40=</span><span class="si">%f</span><span class="s1">, GSBS40=</span><span class="si">%f</span><span class="s1">, HMM109=</span><span class="si">%f</span><span class="s1">, HMM_SM109=</span><span class="si">%f</span><span class="s1">,GSBS109=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">norm</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="n">matchz_mat</span><span class="p">[:</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">])</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>P values for matches to Human bounds: 
HMM40=0.001398, HMM_SM40=0.000275, GSBS40=0.019417, HMM109=0.020840, HMM_SM109=0.014915,GSBS109=0.034652
</pre>
</div>
</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_png output_subarea ">
<img src="../../images/features/notebooks/Event_Segmentation_34_1.png"
>
</div>

</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>These results show that all six sets of boundaries we generated are statistically significant matches to the human boundaries. It also appears that using the split-merge option in the HMM increases the HMM boundaries' similarity to both the human annotations as well as the GSBS boundaries.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="3.-Aligning-movie-and-recall-data">3. Aligning movie and recall data<a class="anchor-link" href="#3.-Aligning-movie-and-recall-data"> </a></h2><p>A simple model of free recall is that a subject will revisit the same sequence of events experienced during perception, but the lengths of the events will not be identical between perception and recall.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="3.1.-Fit-HMM-on-the-two-datasets--simultaneously">3.1. Fit HMM on the two datasets  simultaneously<a class="anchor-link" href="#3.1.-Fit-HMM-on-the-two-datasets--simultaneously"> </a></h3><p>We use the same fit function as for a single dataset, but now we pass in both the movie and recall datasets in a list. We assume the two datasets have shared event transitions.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">movie_recall_HMM</span> <span class="o">=</span> <span class="n">EventSegment</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span>
<span class="n">movie_recall_HMM</span><span class="o">.</span><span class="n">fit</span><span class="p">([</span><span class="n">movie_group</span><span class="p">,</span> <span class="n">recall</span><span class="p">]);</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">movie_recall_HMM</span><span class="o">.</span><span class="n">segments_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">@</span> <span class="n">movie_recall_HMM</span><span class="o">.</span><span class="n">segments_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Timepoints during recall&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Timepoints during movie&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Prob of being in the same event&#39;</span><span class="p">);</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_png output_subarea ">
<img src="../../images/features/notebooks/Event_Segmentation_39_0.png"
>
</div>

</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="3.2-Define-events-from-movie,-find-in-recall">3.2 Define events from movie, find in recall<a class="anchor-link" href="#3.2-Define-events-from-movie,-find-in-recall"> </a></h3>
</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Alternatively, rather than finding events simultaneously in the movie and recall, we can first identify events using the movie data only, and then go looking for this fixed set of events in the recall. In this case we can use other methods, such as GSBS, to identify the events in the movie, and then use the HMM to transfer these events to the recall.</p>
<p>Below we do this for both the 40-event and 109-event segmentations from GSBS. Note that we need to specify a recall event variance for the HMM when applying it in this way - this value controls how confident the model is about whether it knows which event is being recalled given a spatial pattern. This parameter could be cross-validated relative to some other measure of performance, but here we just set the recall variance to be the same as the movie variance for each event.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Use 40 GSBS events to set the HMM event patterns</span>
<span class="n">n_events</span> <span class="o">=</span> <span class="mi">40</span>
<span class="n">event_pat</span> <span class="o">=</span> <span class="n">GSBS_states</span><span class="o">.</span><span class="n">get_state_patterns</span><span class="p">(</span><span class="n">n_events</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
<span class="n">state_labels</span> <span class="o">=</span> <span class="n">GSBS_states</span><span class="o">.</span><span class="n">get_states</span><span class="p">(</span><span class="n">n_events</span><span class="p">)</span>
<span class="n">movie_events40</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nTRs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">state_labels</span><span class="p">)))</span>
<span class="n">movie_events40</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nTRs</span><span class="p">),</span> <span class="n">state_labels</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">HMM</span> <span class="o">=</span> <span class="n">EventSegment</span><span class="p">(</span><span class="n">n_events</span><span class="p">)</span>
<span class="n">HMM</span><span class="o">.</span><span class="n">set_event_patterns</span><span class="p">(</span><span class="n">event_pat</span><span class="p">)</span>
<span class="n">ev_var</span> <span class="o">=</span> <span class="n">HMM</span><span class="o">.</span><span class="n">calc_weighted_event_var</span><span class="p">(</span><span class="n">movie_group</span><span class="p">,</span> <span class="n">movie_events40</span><span class="p">,</span> <span class="n">HMM</span><span class="o">.</span><span class="n">event_pat_</span><span class="p">)</span>
<span class="n">recall_events40</span> <span class="o">=</span> <span class="n">HMM</span><span class="o">.</span><span class="n">find_events</span><span class="p">(</span><span class="n">recall</span><span class="p">,</span> <span class="n">var</span> <span class="o">=</span> <span class="n">ev_var</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>


<span class="c1"># Use 109 GSBS events to set the HMM event patterns</span>
<span class="n">n_events</span> <span class="o">=</span> <span class="n">GSBS_states</span><span class="o">.</span><span class="n">nstates</span>
<span class="n">event_pat</span> <span class="o">=</span> <span class="n">GSBS_states</span><span class="o">.</span><span class="n">state_patterns</span><span class="o">.</span><span class="n">T</span>
<span class="n">state_labels</span> <span class="o">=</span> <span class="n">GSBS_states</span><span class="o">.</span><span class="n">get_states</span><span class="p">()</span>
<span class="n">movie_events109</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nTRs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">state_labels</span><span class="p">)))</span>
<span class="n">movie_events109</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nTRs</span><span class="p">),</span> <span class="n">state_labels</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">HMM</span> <span class="o">=</span> <span class="n">EventSegment</span><span class="p">(</span><span class="n">n_events</span><span class="p">)</span>
<span class="n">HMM</span><span class="o">.</span><span class="n">set_event_patterns</span><span class="p">(</span><span class="n">event_pat</span><span class="p">)</span>
<span class="n">ev_var</span> <span class="o">=</span> <span class="n">HMM</span><span class="o">.</span><span class="n">calc_weighted_event_var</span><span class="p">(</span><span class="n">movie_group</span><span class="p">,</span> <span class="n">movie_events109</span><span class="p">,</span> <span class="n">HMM</span><span class="o">.</span><span class="n">event_pat_</span><span class="p">)</span>
<span class="n">recall_events109</span> <span class="o">=</span> <span class="n">HMM</span><span class="o">.</span><span class="n">find_events</span><span class="p">(</span><span class="n">recall</span><span class="p">,</span> <span class="n">var</span> <span class="o">=</span> <span class="n">ev_var</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">movie_events40</span> <span class="o">@</span> <span class="n">recall_events40</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Timepoints during recall&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Timepoints during movie&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Prob of being in the same event (k=40)&#39;</span><span class="p">);</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">movie_events109</span> <span class="o">@</span> <span class="n">recall_events109</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Timepoints during recall&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Timepoints during movie&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Prob of being in the same event (k=109) &#39;</span><span class="p">);</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_png output_subarea ">
<img src="../../images/features/notebooks/Event_Segmentation_43_0.png"
>
</div>

</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Note that when fitting the model in this way (in which the recall data is not used to define the event patterns) you can obtain recall fits with multiple possible tracking paths, as can be seen in the K=40 plot.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Recommended-reading">Recommended reading<a class="anchor-link" href="#Recommended-reading"> </a></h1><ul>
<li><p>Baldassano, C., Hasson, U., &amp; Norman, K. A. (2018). Representation of real-world event schemas during narrative perception. The Journal of Neuroscience: The Official Journal of the Society for Neuroscience, 38(45), 9689–9699. <a href="https://doi.org/10.1523/JNEUROSCI.0251-18.2018">https://doi.org/10.1523/JNEUROSCI.0251-18.2018</a></p>
</li>
<li><p>Geerligs L., van Gerven M., Güçlü U (2020) Detecting neural state transitions underlying event segmentation biorXiv. <a href="https://doi.org/10.1101/2020.04.30.069989">https://doi.org/10.1101/2020.04.30.069989</a></p>
</li>
</ul>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Contributions">Contributions<a class="anchor-link" href="#Contributions"> </a></h1><p>Chris Baldassano and Gordon Fleetwood developed the initial notebook.</p>
<p>Linda Geerligs added the GSBS method and edited section descriptions.</p>

</div>
</div>
</div>
</div>

 


    </main>
    